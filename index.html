<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order with 6 Persistent Collections</title>
    <style>
        /* Global Reset to prevent width overflow */
        * { 
            box-sizing: border-box; 
        }

        body { 
            font-family: sans-serif; 
            margin: 0; 
            padding: 0;
            overflow-x: hidden; 
            background-color: rgb(245, 200, 245); 
            width: 100%;
        }
        
        header { 
            width: 100%; height: 4rem; border-bottom: 1px solid #ccc; 
            display: flex; justify-content: space-between; align-items: center; 
            position: sticky; top: 0; background: white; z-index: 100;
            padding: 0 5%;
        }

        .logo { height: 40px; width: 40px; object-fit: contain; }
        .nav-links { display: flex; align-items: center; gap: 15px; }
        .nav-links h2 { font-size: 0.9rem; margin: 0; cursor: pointer; color: #333; }
        .order-trigger { background-color: rgb(132, 247, 132); padding: 6px 12px; border: 2px solid #333; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }
        .order-trigger:hover {
            background-color: #25D366;
        }
        #cart-count { background-color: #ffeb3b; padding: 2px 6px; border-radius: 50%; }

        /* --- COLLECTION GRID --- */
        #collection-view {
            padding: 15px;
            width: 100%;
        }

        .collection-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 350px), 1fr)); 
            gap: 20px; 
            width: 100%;
        }

        .collection-card {
            background: rgb(252, 241, 252); border-radius: 12px; padding: 15px; cursor: pointer; 
            transition: 0.3s; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center;
        }
        
        .collection-card:hover{
            transform: translateY(-10px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .image-preview-box {
            border: 1px solid #ddd; 
            display: grid; 
            width: 100%; 
            max-width: 160px; 
            grid-template-columns: 1fr 1fr; 
            margin: 0 auto 10px auto; 
            background: #eee;
            overflow: hidden;
            border-radius: 4px;
        }
        .image-preview-card { border: 0.5px solid #fff; aspect-ratio: 1/1; }
        .image-preview-card img { width: 100%; height: 100%; display: block; object-fit: cover; border: 0.5px solid purple;}

        /* --- 90% SLIDER RESTORED --- */
        #product-slider {
            position: fixed; top: 0; left: 0; width: 90%; height: 100vh;
            background-color: rgb(245, 200, 245); z-index: 150; transform: translateX(-100%); transition: 0.4s ease-in-out;
            box-shadow: 5px 0 25px rgba(0,0,0,0.2); overflow-y: auto;
        }
        #product-slider.active { transform: translateX(0); }
        .slider-header { position: sticky; top: 0; background: white; padding: 15px 5%; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #ddd; z-index: 10; }
        .back-btn { border: none; background: red; color: white; padding: 8px 15px; border-radius: 5px; cursor: pointer; }

        /* --- PRODUCT GRID & CARD RESTORED --- */
        #product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; padding: 15px; }
        .card { background: white; border: 1px solid #eee; padding: 10px; border-radius: 12px; text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.1); width: clamp(10rem, 15vw, 15rem);}
        .card:hover{
            box-shadow: -5px 0 25px rgba(0,0,0,0.5);
            transform: translateY(-10px);
        }
        
        .img-container { width: 100%; height: 120px; border-radius: 8px; overflow: hidden; margin-bottom: 10px; background: #f0f0f0; }
        .iimg { width: 100%; height: 100%; object-fit: cover; display: block; }
        
        .variant-selector { display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; margin: 10px 0; }
        .variant-btn { 
            display: flex; 
            justify-content: space-between; 
            gap: 10px;
            padding: 4px 10px; 
            font-size: 0.7rem; 
            border: 1px solid #ccc; 
            background: white; 
            border-radius: 20px; 
            cursor: pointer; 
            min-width: 100px;
        }
        .variant-btn.active { background: green; color: white; border-color: #333; }
        .unit-text { opacity: 0.8; font-weight: normal; }

        .controls { display: flex; justify-content: center; align-items: center; gap: 10px; min-height: 40px; }
        .controls button { padding: 5px 10px; cursor: pointer; border: 1px solid #333; background: white; border-radius: 4px; font-weight: bold; font-size: 0.8rem; }
        .controls button:hover{
            background: green;
            color: white;
        }
        .qty-btn { background: #ffeb3b !important; border: none !important; }

        /* --- SIDEBAR & POPUP --- */
        #orderSidebar { position: fixed; top: 0; right: 0; width: 400px; max-width: 100%; height: 100vh; background: white; box-shadow: -5px 0 25px rgba(0,0,0,0.15); transition: 0.4s ease-in-out; transform: translateX(100%); z-index: 1000; padding: 20px; overflow-y: auto; }
        #orderSidebar.active { transform: translateX(0); }
        .order-item-detail { display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #eee; padding: 12px 0; }
        .order-item-detail img { width: 45px; height: 45px; object-fit: cover; border-radius: 4px; }
        
        .address-section { margin-top: 15px; background: #f4f4f4; padding: 12px; border-radius: 8px; }
        .address-section input, .address-section textarea { width: 100%; margin-top: 8px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        
        .checkout-btn { width: 100%; padding: 15px; background: #25D366; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: bold; margin-top: 15px; }
        .close-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; float: right; }

        .cart-popup { background-color: rgb(199, 252, 199); position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 320px; padding: 10px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; z-index: 2000; cursor: pointer; }
        .popup-images { display: flex; gap: 4px; margin-bottom: 6px; }
        .cart-popup img { width: 30px; height: 30px; object-fit: cover; border-radius: 4px; }
        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .collection-grid { 
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>

    <div id="cart-popup" class="cart-popup hidden" onclick="toggleSidebar()">
        <div id="popup-images-container" class="popup-images"></div>
        <p style="margin:0; font-size: 0.9rem;"><span id="popup-count">0</span> items in cart</p>
    </div>

    <header>
        <img class="logo" src="logo.jpg" alt="Logo" onerror="this.src='https://via.placeholder.com/40'">
        <div class="nav-links">
            <h2 onclick="location.reload()">Collections</h2>
            <div class="order-trigger" onclick="toggleSidebar()">
                Cart: <span id="cart-count">0</span>
            </div>
        </div>
    </header>

    <main id="collection-view">
        <div class="collection-grid" id="collection-grid"></div>
    </main>

    <div id="product-slider">
        <div class="slider-header">
            <h3 id="slider-title" style="margin:0;">Collection</h3>
            <button class="back-btn" onclick="toggleSlider()">‚úï</button>
        </div>
        <div id="product-grid"></div>
    </div>

    <div id="orderSidebar">
        <button class="close-btn" onclick="toggleSidebar()">√ó</button>
        <h2>Checkout</h2>
        <div id="sidebar-content"></div>
        <div id="sidebar-footer">
            <hr>
            <p>Items Total: Rs <span id="subtotal-val">0</span></p>
            <p>Delivery Charges: Rs <span id="delivery-val">0</span></p>
            <h3>Total Amount: Rs <span id="total-price">0</span></h3>
            <div class="address-section">
                <input type="text" id="cust-name" placeholder="Your Name">
                <textarea id="cust-address" rows="3" placeholder="Address"></textarea>
                <button style="background: #007bff; color: white; border: none; padding: 10px; width: 100%; border-radius: 4px; margin-top: 10px; cursor: pointer;" onclick="getLocation()">üìç Share Location</button>
                <span id="location-display" style="font-size: 11px; color: #666; display: block; margin-top: 5px;"></span>
            </div>
            <button class="checkout-btn" onclick="confirmAndSend()">Place Order on WhatsApp</button>
        </div>
    </div>

    <script>
        // Keeping all 6 collections as requested
        const collections = [
            { id: "snacks", name: "Snacks", previews: ["alu.jpg", "bikkit.jpg", "namkeen.jpg", "namkeen.jpg"] },
            { id: "grocery", name: "Grocery", previews: ["atta.jpg", "oil.jpg", "dal.jpg", "rice.jpg"] },
            { id: "dairy", name: "Dairy", previews: ["milk.jpg", "egg.jpg", "bread.jpg", "cheese.jpg"] },
            { id: "cleaning", name: "Cleaning", previews: ["soap.jpg", "surf.jpg", "mop.jpg", "brush.jpg"] },
            { id: "personal", name: "Personal Care", previews: ["paste.jpg", "shampoo.jpg", "cream.jpg", "perfume.jpg"] },
            { id: "drinks", name: "Beverages", previews: ["coke.jpg", "juice.jpg", "tea.jpg", "water.jpg"] }
        ];

        const products = [
            { 
                id: 0, name: "Alu Bhujiya", image: "alu.jpg", cat: "snacks",
                selectedVariant: "Small",
                variants: { 
                    "Small": { price: 20, count: 0, unit: "40mg" }, 
                    "Medium": { price: 50, count: 0, unit: "150mg" }, 
                    "Large": { price: 100, count: 0, unit: "1kg" } 
                }
            },
            { 
                id: 1, name: "Atta Bag", image: "atta.jpg", cat: "grocery",
                selectedVariant: "Small",
                variants: { 
                    "Small": { price: 180, count: 0, unit: "2kg" }, 
                    "Medium": { price: 350, count: 0, unit: "5kg" }, 
                    "Large": { price: 650, count: 0, unit: "10kg" } 
                }
            }
        ];

        let recentAdditions = [];

        function renderCollections() {
            document.getElementById('collection-grid').innerHTML = collections.map(c => `
                <div class="collection-card" onclick="openCollection('${c.id}', '${c.name}')">
                    <div class="image-preview-box">
                        ${c.previews.map(img => `<div class="image-preview-card"><img src="${img}" onerror="this.src='https://via.placeholder.com/64'"></div>`).join('')}
                    </div>
                    <h3 style="margin: 5px 0 0 0; font-size: 1rem;">${c.name}</h3>
                </div>
            `).join('');
        }

        function openCollection(catId, catName) {
            document.getElementById('slider-title').innerText = catName;
            renderProducts(catId);
            toggleSlider();
        }

        function toggleSlider() { document.getElementById('product-slider').classList.toggle('active'); }

        function renderProducts(catId) {
            const grid = document.getElementById('product-grid');
            const filtered = products.filter(p => p.cat === catId);
            
            if (filtered.length === 0) {
                grid.innerHTML = `<p style="grid-column: 1/-1; padding: 50px; text-align: center;">Empty for now.</p>`;
                return;
            }

            grid.innerHTML = filtered.map(p => {
                const currentVar = p.variants[p.selectedVariant];
                return `
                <div class="card">
                    <div class="img-container">
                        <img src="${p.image}" class="iimg" onerror="this.src='https://via.placeholder.com/150'">
                    </div>
                    <h4 style="margin: 5px 0; font-size: 0.9rem;">${p.name}</h4>
                    <div class="variant-selector">
                        ${Object.keys(p.variants).map(v => `
                            <button class="variant-btn ${p.selectedVariant === v ? 'active' : ''}" 
                                onclick="selectVariant(${p.id}, '${v}', '${catId}')">
                                <span>${v}</span>
                                <span class="unit-text">${p.variants[v].unit}</span>
                            </button>
                        `).join('')}
                    </div>
                    <p style="margin: 5px 0;"><strong>Rs ${currentVar.price}</strong></p>
                    <div class="controls">
                        <button class="${currentVar.count > 0 ? 'hidden' : ''}" onclick="changeQty(${p.id}, 1, '${catId}')">Add</button>
                        <div class="${currentVar.count > 0 ? '' : 'hidden'}">
                            <button class="qty-btn" onclick="changeQty(${p.id}, -1, '${catId}')">-</button>
                            <span style="margin: 0 8px; font-weight: bold;">${currentVar.count}</span>
                            <button class="qty-btn" onclick="changeQty(${p.id}, 1, '${catId}')">+</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function selectVariant(productId, variantName, catId) {
            products[productId].selectedVariant = variantName;
            renderProducts(catId);
        }

        function changeQty(productId, amount, catId) {
            const p = products[productId];
            const v = p.variants[p.selectedVariant];
            v.count += amount;
            if (v.count < 0) v.count = 0;
            if (amount > 0) {
                recentAdditions.unshift(p.image);
                if (recentAdditions.length > 4) recentAdditions.pop();
            }
            renderProducts(catId);
            updateSidebar();
        }

        function updateSidebar() {
            let itemsTotal = 0, totalItems = 0;
            let html = "";
            products.forEach(p => {
                Object.keys(p.variants).forEach(vName => {
                    const v = p.variants[vName];
                    if (v.count > 0) {
                        itemsTotal += (v.count * v.price);
                        totalItems += v.count;
                        html += `<div class="order-item-detail"><img src="${p.image}"><div><strong>${p.name} (${vName})</strong><br>${v.count} x Rs ${v.price}</div></div>`;
                    }
                });
            });

            // --- Delivery Logic ---
            let delivery = 0;
            if (itemsTotal > 0) {
                if (itemsTotal < 300) {
                    delivery = 50;
                } else if (itemsTotal >= 300 && itemsTotal <= 1000) {
                    delivery = 100;
                } else if (itemsTotal > 1000) {
                    delivery = 200;
                }
            }

            document.getElementById('sidebar-content').innerHTML = html || "<p>Cart is empty</p>";
            document.getElementById('subtotal-val').innerText = itemsTotal;
            document.getElementById('delivery-val').innerText = delivery;
            document.getElementById('total-price').innerText = itemsTotal + delivery;
            document.getElementById('cart-count').innerText = totalItems;
            
            const popup = document.getElementById('cart-popup');
            if(totalItems > 0) {
                popup.classList.remove('hidden');
                document.getElementById('popup-count').innerText = totalItems;
                document.getElementById('popup-images-container').innerHTML = [...new Set(recentAdditions)].slice(0, 5).map(img => `<img src="${img}">`).join('');
            } else { popup.classList.add('hidden'); }
        }

        function toggleSidebar() { document.getElementById('orderSidebar').classList.toggle('active'); }

        async function getLocation() {
            const status = document.getElementById('location-display');
            if (navigator.geolocation) {
                status.innerText = "Locating...";
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    try {
                        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
                        const data = await res.json();
                        document.getElementById('cust-address').value = data.display_name || "Location Tagged";
                        status.innerText = `‚úÖ Location Tagged`;
                    } catch (e) { status.innerText = "‚ùå Reverse Geocode failed"; }
                }, () => { status.innerText = "‚ùå Access Denied"; });
            }
        }

        function confirmAndSend() {
            const finalTotal = document.getElementById('total-price').innerText;
            if (finalTotal == "0") { alert("Cart is empty!"); return; }
            
            const isConfirmed = confirm("Are you sure you want to place this order on WhatsApp?");
            if (isConfirmed) {
                sendToWhatsApp();
            }
        }

        function sendToWhatsApp() {
            const name = document.getElementById('cust-name').value;
            const address = document.getElementById('cust-address').value;
            if (!name || !address) { alert("Please fill Name and Address"); return; }
            
            let msg = `*NEW ORDER*%0A*Customer:* ${name}%0A*Address:* ${address}%0A%0A`;
            products.forEach(p => {
                Object.keys(p.variants).forEach(vName => {
                    const v = p.variants[vName];
                    if (v.count > 0) msg += `‚Ä¢ ${p.name} (${vName}) x${v.count}%0A`;
                });
            });
            msg += `%0A*Items Total: Rs ${document.getElementById('subtotal-val').innerText}*`;
            msg += `%0A*Delivery: Rs ${document.getElementById('delivery-val').innerText}*`;
            msg += `%0A*Grand Total: Rs ${document.getElementById('total-price').innerText}*`;
            
            window.open(`https://wa.me/7983427187?text=${msg}`, '_blank');
        }

        renderCollections();
    </script>
</body>
</html>
